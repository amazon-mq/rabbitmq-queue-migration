<!--
Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
SPDX-License-Identifier: Apache-2.0
-->

<h1>Queue Migration</h1>

<!-- Message shown when migration is started -->
<div id="migration-started-message" class="info" style="display: none;">
  <p>Migration has been started. The page will refresh automatically to show progress.</p>
</div>

<% var migrationInProgress = queue_migration_status && queue_migration_status.status === 'in_progress'; %>

<div id="migration-controls" style="<%= migrationInProgress ? 'display: none;' : '' %>">
  <div class="section">
    <h2>Options</h2>
    <table class="form">
      <tr>
        <th><label>Virtual Host:</label></th>
        <td>
          <select name="vhost" id="migration-vhost">
            <% for (var i = 0; i < vhosts.length; i++) { %>
              <option value="<%= fmt_string(vhosts[i].name) %>"><%= fmt_string(vhosts[i].name) %></option>
            <% } %>
          </select>
        </td>
      </tr>
      <tr>
        <th><label for="skip_unsuitable_queues">Skip Unsuitable Queues:</label></th>
        <td>
          <input type="checkbox" name="skip_unsuitable_queues" id="skip_unsuitable_queues"
                 title="Skip queues that fail validation checks instead of blocking migration" />
        </td>
      </tr>
      <tr>
        <th><label>Batch Size:</label></th>
        <td>
          <input type="radio" name="batch_mode" id="batch_limited" value="limited" style="display: inline; vertical-align: middle;" />
          <input type="number" name="batch_size" id="batch_size" min="1" value="10" title="Number of queues to migrate" style="width: 60px; display: inline; vertical-align: middle;" /> queues
          <br/>
          <input type="radio" name="batch_mode" id="batch_all" value="all" style="display: inline; vertical-align: middle;" />
          <label for="batch_all" style="display: inline;"> All</label>
        </td>
      </tr>
      <tr>
        <th><label for="batch_order">Batch Order:</label></th>
        <td>
          <select name="batch_order" id="batch_order" title="Order in which to migrate queues when using batch size">
            <option value="smallest_first">Smallest first</option>
            <option value="largest_first">Largest first</option>
          </select>
        </td>
      </tr>
    </table>
  </div>

  <div class="section">
    <h2>Check Compatibility</h2>
    <p>Check classic queues for compatibility with quorum queues before starting migration.</p>
    <form action="#/queue-migration/check" method="post" id="check-compatibility-form">
      <input type="hidden" name="vhost" id="check-vhost" />
      <input type="hidden" name="skip_unsuitable_queues" id="check-skip" />
      <input type="submit" value="Check Compatibility" />
    </form>
    <div id="compatibility-results"></div>
  </div>

  <div class="section">
    <h2>Start Migration</h2>
    <p>Start migration for the selected virtual host.</p>
    <button id="start-migration-btn" type="button">Start Migration</button>
  </div>
</div>

<div id="migration-in-progress" class="section" style="<%= migrationInProgress ? '' : 'display: none;' %>">
  <h2>Migration In Progress</h2>
  <p class="warning">A migration is currently in progress. Starting a new migration is not allowed until the current one completes.</p>
</div>

<div class="section">
  <h2>Migration History</h2>
  <% if (queue_migration_status) { %>
    <p>Migration system status: <b><%= fmt_system_status(queue_migration_status.status) %></b></p>

    <% if (queue_migration_status.migrations && queue_migration_status.migrations.length > 0) { %>
      <table class="list updatable">
        <thead>
          <tr>
            <th><%= fmt_sort_desc_by_default('Virtual Host', 'display_id') %></th>
            <th><%= fmt_sort_desc_by_default('Started (UTC)', 'started_at') %></th>
            <th><%= fmt_sort_desc_by_default('Completed (UTC)', 'completed_at') %></th>
            <th><%= fmt_sort_desc_by_default('Status', 'status') %></th>
            <th><%= fmt_sort_desc_by_default('Progress', 'progress_percentage') %></th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% for (var i = 0; i < queue_migration_status.migrations.length; i++) { %>
            <tr<%= alt_rows(i) %>>
              <td><%= fmt_string(queue_migration_status.migrations[i].vhost) %></td>
              <td><%= fmt_string(queue_migration_status.migrations[i].started_at) %></td>
              <td><%= fmt_string(queue_migration_status.migrations[i].completed_at) %></td>
              <td>
                <%= fmt_migration_status(queue_migration_status.migrations[i].status) %>
                <% if (queue_migration_status.migrations[i].error) { %>
                  <br/><span class="status-red" style="font-size: 0.9em;"><%= fmt_string(queue_migration_status.migrations[i].error) %></span>
                <% } %>
              </td>
              <td>
                <%= fmt_progress_bar(
                  queue_migration_status.migrations[i].completed_queues,
                  queue_migration_status.migrations[i].total_queues
                ) %>
              </td>
              <td>
                <a href="#/queue-migration/status/<%= queue_migration_status.migrations[i].id %>">View Details</a>
              </td>
            </tr>
          <% } %>
        </tbody>
      </table>
    <% } else { %>
      <p>No migrations have been performed yet.</p>
    <% } %>
  <% } else { %>
    <p>Unable to retrieve migration status.</p>
  <% } %>
</div>

<style type="text/css">
.progress-bar {
  width: 100px;
  height: 10px;
  background-color: #f0f0f0;
  border-radius: 5px;
  display: inline-block;
  margin-right: 5px;
}
.progress {
  height: 100%;
  background-color: #0088ce;
  border-radius: 5px;
}
.status-green {
  color: #008800;
  font-weight: bold;
}
.status-blue {
  color: #0088ce;
  font-weight: bold;
}
.status-red {
  color: #cc0000;
  font-weight: bold;
}
.status-yellow {
  color: #ddaa00;
  font-weight: bold;
}
.info {
  background-color: #d9edf7;
  border: 1px solid #bce8f1;
  color: #31708f;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}
.warning {
  background-color: #fcf8e3;
  border: 1px solid #faebcc;
  color: #8a6d3b;
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 4px;
}
</style>
